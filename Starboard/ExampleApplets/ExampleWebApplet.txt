using ImGuiNET;
using System.Numerics;
using Overlay_Renderer.Methods;
using Starboard.DistributedApplets;

namespace Starboard.ExampleApplets
{
    /// <summary>
    /// Example applet for experimenting with web pages.
    /// NOTE: This does NOT render HTML yet – it just provides
    /// the UI and explains what needs wiring up.
    /// </summary>
    internal sealed class ExampleWebApplet : IStarboardApplet
    {
        public string Id => "starboard.example.web";
        public string DisplayName => "Web Page Tester";
        public bool UsesWebView => true;

        // Default to something Star Citizen–related for fun
        private string _url = "https://robertsspaceindustries.com/";
        private string _status = "Idle";

        // Optional metadata for a future favicon/icon loader.
        // Not used by StarboardMain yet.
        public string? FaviconUrl => _url + "/favicon.ico";

        public void Initialize()
        {
            // No-op for now
        }

        public void Draw(float dt, Vector2 availableSize)
        {
            ImGui.Text("Web Page Test Applet");
            ImGui.Separator();

            ImGui.TextWrapped(
                "Enter a URL and the page will be rendered into the panel on the right. " +
                "Note: this first version uses WebView2 + GDI capture, so performance is not amazing yet.");

            ImGui.Dummy(new Vector2(0, 8));

            // URL input
            if (ImGui.InputText("URL", ref _url, 2048, ImGuiInputTextFlags.EnterReturnsTrue))
            {
                WebBrowserManager.Navigate(Id, _url);
            }

            ImGui.Dummy(new Vector2(0, 4));

            if (ImGui.Button("Open in browser"))
            {
                try
                {
                    System.Diagnostics.Process.Start(new System.Diagnostics.ProcessStartInfo
                    {
                        FileName = _url,
                        UseShellExecute = true
                    });
                    _status = "Opened in default browser.";
                }
                catch (Exception ex)
                {
                    _status = $"Failed: {ex.Message}";
                }
            }

            ImGui.SameLine();
            ImGui.TextDisabled(_status);

            ImGui.Dummy(new Vector2(0, 12));
            ImGui.Separator();

            ImGui.Text("Embedded view:");
            ImGui.Dummy(new Vector2(0, 4));

            // *** Key change here: use actual remaining region ***
            Vector2 viewportSize = ImGui.GetContentRegionAvail();
            WebBrowserManager.DrawWebPage(Id, _url, viewportSize);
        }

    }
}